<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Factory v7.0 (Switchable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #0F172A; color: #E2E8F0; }
        
        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { color: #E2E8F0; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
        .prose h1 { font-size: 1.8em; border-bottom: 2px solid #334155; }
        .prose h2 { font-size: 1.5em; border-left: 5px solid #3B82F6; padding-left: 0.5em; }
        .prose p, .prose ul, .prose ol { color: #CBD5E1; margin-bottom: 1em; line-height: 1.8; }
        .prose strong { color: #38BDF8; }
        
        /* Paid Mode Styles */
        .mode-paid .prose h2 { border-color: #F59E0B; }
        .mode-paid .prose strong { color: #FCD34D; }
        
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .topic-card:hover { transform: translateY(-2px); border-color: #3B82F6; background: rgba(59, 130, 246, 0.1); cursor: pointer; }
        
        /* Paywall Style */
        .paywall-container {
            margin: 3rem 0;
            text-align: center;
            position: relative;
        }
        .paywall-line {
            border-top: 2px dashed #F59E0B;
            width: 100%;
            position: absolute;
            top: 50%;
            z-index: 0;
        }
        .paywall-label {
            position: relative;
            z-index: 1;
            background: #0F172A;
            color: #F59E0B;
            padding: 0.5rem 1.5rem;
            border: 1px solid #F59E0B;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
        }
        .paid-zone {
            background: rgba(245, 158, 11, 0.03);
            border-left: 1px solid rgba(245, 158, 11, 0.2);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #3B82F6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .hashtag-chip {
            display: inline-block;
            background-color: rgba(59, 130, 246, 0.2);
            color: #60A5FA;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #F59E0B;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #F59E0B;
        }
        .thread-line {
            position: absolute; left: 24px; top: 48px; bottom: -16px; width: 2px; background-color: #334155; z-index: 0;
        }
        .thread-item:last-child .thread-line { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="border-b border-gray-700 sticky top-0 z-50 bg-[#0F172A]/90 backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                    <span class="text-2xl">ğŸ­</span> Gemini Factory <span class="text-xs bg-indigo-600 px-1 rounded">v7.0</span>
                </h1>
                <div class="relative group">
                    <select id="modelSelect" class="text-xs bg-gray-800 border border-gray-600 rounded px-2 py-1 text-gray-300 focus:outline-none focus:border-blue-500 min-w-[200px]">
                        <option value="" disabled selected>ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—ä¸­...</option>
                    </select>
                    <div id="modelStatus" class="absolute -bottom-5 left-0 text-[10px] text-gray-400 whitespace-nowrap"></div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="clearApiKey()" class="text-xs text-gray-400 hover:text-red-400 underline">APIã‚­ãƒ¼å‰Šé™¤</button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
            <div class="bg-gray-800 p-8 rounded-xl max-w-md w-full border border-gray-600 shadow-2xl">
                <h2 class="text-xl font-bold text-white mb-4">åˆæœŸè¨­å®š</h2>
                <p class="text-gray-400 text-sm mb-4">Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>å…¥åŠ›å¾Œã€åˆ©ç”¨å¯èƒ½ãªæœ€æ–°ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’è‡ªå‹•å–å¾—ã—ã¾ã™ã€‚</p>
                <input type="password" id="inputApiKey" placeholder="sk-..." class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white mb-4 focus:border-blue-500 outline-none">
                <button onclick="saveApiKey()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition">ä¿å­˜ã—ã¦é–‹å§‹</button>
                <p class="text-xs text-gray-500 mt-4 text-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-blue-400">APIã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ (Google AI Studio)</a>
                </p>
                <div id="apiCheckStatus" class="mt-2 text-xs text-center text-yellow-400 hidden"></div>
            </div>
        </div>

        <!-- Step 1: Input -->
        <section id="inputSection" class="glass-panel p-8 rounded-xl shadow-lg text-center max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold text-white mb-2">ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ & ãƒã‚¿å‡ºã—</h2>
            <p class="text-gray-400 mb-6 text-sm">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIãŒãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æã—ã€è¨˜äº‹æ¡ˆã‚’20å€‹ææ¡ˆã—ã¾ã™ã€‚</p>
            
            <div class="relative max-w-lg mx-auto">
                <input type="text" id="keyword" placeholder="ä¾‹ï¼šAIå‰¯æ¥­ã€ãƒŸãƒ‹ãƒãƒªã‚¹ãƒˆã€æ¨ã—æ´»..." 
                    class="w-full bg-gray-800 border border-gray-600 rounded-full px-6 py-4 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-lg shadow-inner"
                    onkeydown="if(event.key === 'Enter') analyzeTrends()">
                <button onclick="analyzeTrends()" id="analyzeBtn" class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 rounded-full transition-all shadow-md flex items-center gap-2">
                    <span id="analyzeIcon">ğŸ”</span>
                </button>
            </div>
        </section>

        <!-- Status Bar -->
        <div id="statusSection" class="hidden max-w-3xl mx-auto">
            <div class="bg-gray-800 rounded-lg p-4 flex items-center gap-4 border border-gray-700 shadow-lg">
                <div class="loader" id="statusLoader"></div>
                <div class="flex-grow">
                    <p id="statusText" class="text-sm font-bold text-blue-400 typing">AI AGENT IS WORKING...</p>
                    <p id="statusSub" class="text-xs text-gray-500">GeminiãŒå¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æä¸­...</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Topic Selection & Mode Switch -->
        <section id="topicsSection" class="hidden fade-in">
            
            <!-- Mode Switcher -->
            <div class="glass-panel p-4 rounded-xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border border-gray-700">
                <div class="flex items-center gap-2">
                    <h3 class="text-lg font-bold text-white">è¨˜äº‹ãƒ†ãƒ¼ãƒæ¡ˆ (20é¸)</h3>
                    <span class="text-xs text-gray-400 ml-2">æ›¸ããŸã„ãƒ†ãƒ¼ãƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span>
                </div>

                <!-- Toggle -->
                <div class="flex items-center gap-3 bg-gray-900 p-2 rounded-lg border border-gray-600">
                    <span class="text-sm font-bold text-blue-400">ç„¡æ–™è¨˜äº‹</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="paidToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-600"></div>
                    </label>
                    <span class="text-sm font-bold text-yellow-500">æœ‰æ–™è¨˜äº‹ (åç›ŠåŒ–)</span>
                </div>
            </div>
            
            <div id="topicsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Topics will be injected here -->
            </div>
            
            <div class="text-center mt-8">
                <button onclick="resetAll()" class="text-sm text-gray-400 hover:text-white border border-gray-600 px-4 py-2 rounded hover:bg-gray-800 transition">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã«æˆ»ã‚‹</button>
            </div>
        </section>

        <!-- Step 3 & 4: Article Generation -->
        <section id="articleSection" class="hidden fade-in space-y-4">
            
            <!-- Navigation Back -->
            <div class="flex justify-start">
                <button onclick="backToTopics()" class="text-sm text-gray-400 hover:text-white flex items-center gap-2 px-3 py-1 rounded hover:bg-gray-800 transition-colors">
                    <span>â†</span> ãƒ†ãƒ¼ãƒä¸€è¦§ã«æˆ»ã‚‹
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Outline -->
                <div class="space-y-6">
                    <div class="space-y-4">
                        <div class="bg-gray-800 px-4 py-2 rounded-t-lg border-b border-gray-700 flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-300">ğŸ“Š æ§‹æˆæ¡ˆ (Outline)</span>
                            <span id="outlineBadge" class="text-xs bg-gray-700 text-gray-400 px-2 py-1 rounded">Normal Mode</span>
                        </div>
                        <div class="glass-panel p-6 rounded-b-lg min-h-[600px] max-h-[800px] overflow-y-auto custom-scrollbar">
                            <div id="outlineContent" class="prose prose-invert max-w-none text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Full Body & Threads -->
                <div class="space-y-8">
                    <!-- Note Body -->
                    <div class="space-y-4">
                        <div class="bg-blue-900/30 px-4 py-2 rounded-t-lg border-b border-blue-800/50 flex justify-between items-center" id="articleHeader">
                            <span class="text-sm font-bold text-blue-300">ğŸ“ è¨˜äº‹æœ¬æ–‡ (Draft)</span>
                            <button onclick="copyArticle()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition">æœ¬æ–‡ã‚³ãƒ”ãƒ¼</button>
                        </div>
                        <div class="glass-panel p-6 rounded-b-lg min-h-[400px] max-h-[600px] overflow-y-auto custom-scrollbar" id="articleContainer">
                            <div id="articleContent" class="prose prose-invert max-w-none"></div>
                            
                            <!-- Hashtags -->
                            <div class="mt-6 pt-4 border-t border-gray-700">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-bold text-indigo-300">ğŸ·ï¸ æ¨å¥¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</span>
                                    <button onclick="copyHashtags()" class="text-[10px] text-gray-400 hover:text-white">ã‚¿ã‚°ã‚³ãƒ”ãƒ¼</button>
                                </div>
                                <div id="hashtagContent" class="flex flex-wrap gap-2 text-sm">
                                    <span class="text-gray-500 text-xs">...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Threads Post -->
                    <div class="space-y-4">
                        <div class="bg-black/60 px-4 py-2 rounded-t-lg border-b border-gray-700 flex justify-between items-center">
                            <span class="text-sm font-bold text-white flex items-center gap-2">
                                <span class="w-4 h-4 rounded-full bg-white text-black flex items-center justify-center font-bold text-[10px]">@</span>
                                ThreadsæŠ•ç¨¿æ¡ˆ
                            </span>
                            <button onclick="copyThreads()" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded transition">å…¨æ–‡ã‚³ãƒ”ãƒ¼</button>
                        </div>
                        <div class="glass-panel p-6 rounded-b-lg bg-black/40">
                            <div id="threadsContent" class="space-y-6">
                                <span class="text-gray-500 text-xs text-center block">è¨˜äº‹ä½œæˆå¾Œã«ç”Ÿæˆã•ã‚Œã¾ã™...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

    </main>

    <script>
        // --- API Key & Model Discovery ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedKey = localStorage.getItem('gemini_api_key');
            if (!storedKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
            } else {
                fetchModels(storedKey);
            }
        });

        async function saveApiKey() {
            const key = document.getElementById('inputApiKey').value.trim();
            if (!key) return alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            
            const statusDiv = document.getElementById('apiCheckStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerText = "ã‚­ãƒ¼ã‚’ç¢ºèªã—ã€åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ä¸­...";
            
            const success = await fetchModels(key);
            if (success) {
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('apiKeyModal').classList.add('hidden');
            } else {
                statusDiv.innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            }
        }

        function getApiKey() { return localStorage.getItem('gemini_api_key'); }
        function clearApiKey() {
            if(confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('gemini_api_key');
                location.reload();
            }
        }

        async function fetchModels(apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
            const select = document.getElementById('modelSelect');
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Key Invalid");
                const data = await response.json();
                const models = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                select.innerHTML = '';
                models.sort((a, b) => {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA.includes('flash') && !nameB.includes('flash')) return -1;
                    return 0;
                });
                models.forEach(m => {
                    const option = document.createElement('option');
                    const value = m.name.replace('models/', '');
                    option.value = value;
                    option.text = `${value}`;
                    select.appendChild(option);
                });
                document.getElementById('modelStatus').innerText = `âœ… ${models.length}ãƒ¢ãƒ‡ãƒ«å–å¾—æ¸ˆ`;
                return true;
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="gemini-1.5-flash">gemini-1.5-flash (Fallback)</option>';
                return false;
            }
        }

        // --- Core Gemini Caller ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function callGemini(prompt, retries = 5) {
            const apiKey = getApiKey();
            if (!apiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
                throw new Error("API Key missing");
            }

            let modelName = document.getElementById('modelSelect').value || "gemini-1.5-flash";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const waitTime = Math.pow(2, i) * 2000; 
                        setStatus(true, "ãƒ¬ãƒ¼ãƒˆåˆ¶é™(429)...", `${waitTime/1000}ç§’å¾…æ©Ÿã—ã¦å†è©¦è¡Œã—ã¾ã™ (${i+1}/${retries})`);
                        await sleep(waitTime);
                        continue;
                    }

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "API Error");
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;

                } catch (e) {
                    if (i === retries - 1) throw e;
                }
            }
        }

        function setStatus(loading, mainText, subText) {
            const section = document.getElementById('statusSection');
            if (loading) {
                section.classList.remove('hidden');
                document.getElementById('statusText').innerText = mainText;
                document.getElementById('statusSub').innerText = subText || "";
            } else {
                section.classList.add('hidden');
            }
        }

        function resetAll() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('articleSection').classList.add('hidden');
            document.getElementById('keyword').value = '';
        }

        function backToTopics() {
            document.getElementById('articleSection').classList.add('hidden');
            document.getElementById('topicsSection').classList.remove('hidden');
            setStatus(false);
        }

        // --- Step 1: Trend Analysis ---
        async function analyzeTrends() {
            const keyword = document.getElementById('keyword').value;
            if (!keyword) return alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            document.getElementById('inputSection').classList.add('hidden');
            setStatus(true, "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­...", `ã€Œ${keyword}ã€ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆåˆ†æä¸­`);

            const prompt = `
            ã‚ãªãŸã¯ãƒ—ãƒ­ã®Webç·¨é›†é•·ã§ã™ã€‚
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€Noteã§èª­ã¾ã‚Œã‚‹è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã®æ¡ˆã‚’20å€‹ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
            ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯åˆå¿ƒè€…ã€œä¸­ç´šè€…ã€‚ãƒã‚¦ãƒ„ãƒ¼ã€ãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆã€ä½“é¨“è«‡ãªã©ç¶²ç¾…çš„ã«ã€‚
            å‡ºåŠ›å½¢å¼: JSONé…åˆ—ã®ã¿ï¼ˆä¾‹: ["ã‚¿ã‚¤ãƒˆãƒ«1", "ã‚¿ã‚¤ãƒˆãƒ«2", ...]ï¼‰ã€‚ä½™è¨ˆãªèª¬æ˜ä¸è¦ã€‚
            `;

            try {
                let text = await callGemini(prompt);
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const jsonMatch = text.match(/\[[\s\S]*\]/);
                if (jsonMatch) text = jsonMatch[0];

                const topics = JSON.parse(text);
                renderTopics(topics);
                setStatus(false);
                document.getElementById('topicsSection').classList.remove('hidden');

            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
                document.getElementById('inputSection').classList.remove('hidden');
                setStatus(false);
            }
        }

        function renderTopics(topics) {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = "";
            topics.forEach((title, index) => {
                const div = document.createElement('div');
                div.className = "topic-card glass-panel p-4 rounded-lg border border-gray-700 hover:border-blue-500 relative group";
                div.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2 font-mono">IDEA #${String(index + 1).padStart(2, '0')}</div>
                    <div class="font-bold text-gray-200 group-hover:text-white">${title}</div>
                    <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity text-blue-400 text-xs font-bold">åŸ·ç­†ã™ã‚‹ â†’</div>
                `;
                div.onclick = () => startWriting(title);
                grid.appendChild(div);
            });
        }

        // --- Step 2: Writing (Mode Switched) ---
        async function startWriting(title) {
            // Check Mode
            const isPaid = document.getElementById('paidToggle').checked;
            
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('articleSection').classList.remove('hidden');
            
            // UI Update for Paid Mode
            const outlineBadge = document.getElementById('outlineBadge');
            const articleContainer = document.getElementById('articleContainer');
            const articleHeader = document.getElementById('articleHeader');
            
            if (isPaid) {
                outlineBadge.innerText = "æœ‰æ–™è¨˜äº‹ãƒ¢ãƒ¼ãƒ‰";
                outlineBadge.className = "text-xs bg-yellow-900 text-yellow-200 px-2 py-1 rounded";
                articleContainer.classList.add("mode-paid");
                articleHeader.className = "bg-yellow-900/30 px-4 py-2 rounded-t-lg border-b border-yellow-800/50 flex justify-between items-center";
                articleHeader.querySelector('span').className = "text-sm font-bold text-yellow-300";
            } else {
                outlineBadge.innerText = "ç„¡æ–™è¨˜äº‹ãƒ¢ãƒ¼ãƒ‰";
                outlineBadge.className = "text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded";
                articleContainer.classList.remove("mode-paid");
                articleHeader.className = "bg-blue-900/30 px-4 py-2 rounded-t-lg border-b border-blue-800/50 flex justify-between items-center";
                articleHeader.querySelector('span').className = "text-sm font-bold text-blue-300";
            }

            document.getElementById('outlineContent').innerHTML = '<div class="text-gray-500 text-center mt-20">æ§‹æˆæ¡ˆã‚’ä½œæˆä¸­...</div>';
            document.getElementById('articleContent').innerHTML = '<div class="text-gray-500 text-center mt-20">å¾…æ©Ÿä¸­...</div>';
            document.getElementById('hashtagContent').innerHTML = '<span class="text-gray-500">...</span>';
            document.getElementById('threadsContent').innerHTML = '<span class="text-gray-500 text-center block mt-10">å¾…æ©Ÿä¸­...</span>';

            try {
                // 1. Outline
                setStatus(true, isPaid ? "æœ‰æ–™è¨˜äº‹ã®æ§‹æˆæ¡ˆã‚’ä½œæˆä¸­..." : "ç„¡æ–™è¨˜äº‹ã®æ§‹æˆæ¡ˆã‚’ä½œæˆä¸­...", `ã‚¿ã‚¤ãƒˆãƒ«: ${title}`);
                
                let outlinePrompt = `ã‚¿ã‚¤ãƒˆãƒ«: ${title}\nMarkdownå½¢å¼ã§ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€æ¤œç´¢æ„å›³ã€H2/H3è¦‹å‡ºã—ã‚’å«ã‚€æ§‹æˆæ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
                
                if (isPaid) {
                    outlinePrompt += `\nã€é‡è¦ï¼šæœ‰æ–™è²©å£²ç”¨ã€‘è¨˜äº‹ã®å‰åŠï¼ˆç„¡æ–™éƒ¨åˆ†ï¼‰ã§ä¿¡é ¼ã‚’å¾—ã¦ã€å¾ŒåŠï¼ˆæœ‰æ–™éƒ¨åˆ†ï¼‰ã§æ ¸å¿ƒçš„ãªãƒã‚¦ãƒã‚¦ã‚’æä¾›ã™ã‚‹æ§‹æˆã«ã—ã¦ãã ã•ã„ã€‚æœ‰æ–™ã‚¨ãƒªã‚¢ã®åˆ‡ã‚Šæ›¿ãˆãƒã‚¤ãƒ³ãƒˆã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚`;
                }

                const outlineMd = await callGemini(outlinePrompt);
                document.getElementById('outlineContent').innerHTML = marked.parse(outlineMd);
                await sleep(2000);

                // 2. Full Article
                setStatus(true, "è¨˜äº‹æœ¬æ–‡ã‚’åŸ·ç­†ä¸­...", isPaid ? "ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«ã‚’è¨­ç½®ä¸­" : "å…¨æ–‡åŸ·ç­†ä¸­");
                
                let bodyPrompt = `ä»¥ä¸‹ã®æ§‹æˆæ¡ˆã‚’å…ƒã«ã€Noteã®è¨˜äº‹æœ¬æ–‡ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚\nã€æ§‹æˆæ¡ˆã€‘${outlineMd}\nã€åŸ·ç­†ãƒ«ãƒ¼ãƒ«ã€‘åª’ä½“: Noteã€Markdownå½¢å¼ã€3000æ–‡å­—ç¨‹åº¦ã€‚`;
                
                if (isPaid) {
                    bodyPrompt += `\nã€é‡è¦ï¼šãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«è¨­ç½®ã€‘
                    - è¨˜äº‹ã®æœ‰æ–™ã‚¨ãƒªã‚¢ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹å ´æ‰€ã«ã€å¿…ãšã€Œ[[PAYWALL]]ã€ã¨ã„ã†æ–‡å­—åˆ—ã‚’**1å›ã ã‘**æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
                    - ç„¡æ–™ã‚¨ãƒªã‚¢ï¼šèª­è€…ã®æ‚©ã¿ã«å…±æ„Ÿã—ã€è§£æ±ºã®æ–¹å‘æ€§ã‚’ç¤ºã™ã€‚
                    - æœ‰æ–™ã‚¨ãƒªã‚¢ï¼šå…·ä½“çš„ãªæ‰‹é †ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€å®Ÿãƒ‡ãƒ¼ã‚¿ãªã©ã€‚
                    `;
                } else {
                    bodyPrompt += `\nã€é‡è¦ã€‘å…¨æ–‡ç„¡æ–™ã§å…¬é–‹ã™ã‚‹è¨˜äº‹ã¨ã—ã¦ã€æœ€å¾Œã¾ã§æƒœã—ã¿ãªãæƒ…å ±ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚`;
                }

                const articleMd = await callGemini(bodyPrompt);
                
                // Render Paywall
                let htmlContent = marked.parse(articleMd);
                if (isPaid) {
                    // Replace [[PAYWALL]] with visual divider
                    htmlContent = htmlContent.replace(
                        '[[PAYWALL]]', 
                        `<div class="paywall-container"><div class="paywall-line"></div><span class="paywall-label">ğŸ”’ ã“ã“ã‹ã‚‰æœ‰æ–™ã‚¨ãƒªã‚¢</span></div><div class="paid-zone">`
                    ) + '</div>'; // Close div
                }
                
                document.getElementById('articleContent').innerHTML = htmlContent;
                await sleep(2000);

                // 3. Hashtags
                const hashtagPrompt = `è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«: ${title}\nã“ã®è¨˜äº‹ã«ãŠã™ã™ã‚ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’10å€‹ã€åŠè§’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å‡ºåŠ›ï¼ˆä¾‹: #AI #å‰¯æ¥­ ...ï¼‰ã€‚`;
                let hashtags = await callGemini(hashtagPrompt);
                hashtags = hashtags.trim().replace(/ã€/g, ' ').replace(/,/g, ' ');
                renderHashtags(hashtags);
                await sleep(2000);

                // 4. Threads Post
                setStatus(true, "ThreadsæŠ•ç¨¿ã‚’ä½œæˆä¸­...", "25æ­³å¥³æ€§ãƒãƒ¼ã‚±ã‚¿ãƒ¼è¦–ç‚¹");
                let threadsPrompt = `
                ä»¥ä¸‹ã®Noteè¨˜äº‹ã‚’å®£ä¼ã™ã‚‹ãŸã‚ã®Threadsï¼ˆã‚¹ãƒ¬ãƒƒã‚ºï¼‰ã®æŠ•ç¨¿æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                ã€è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã€‘${title}
                ã€è¨˜äº‹å†…å®¹ã€‘${articleMd}
                ã€ãƒšãƒ«ã‚½ãƒŠã€‘25æ­³å¥³æ€§ãƒãƒ¼ã‚±ã‚¿ãƒ¼ã€‚çŸ¥çš„ã ãŒè¦ªã—ã¿ã‚„ã™ã„ã€‚ã€Œã€œã ã‚ˆã­ã€ã€Œã€œãªã‚“ã§ã™ã€ã€‚
                ã€æ¡ä»¶ã€‘3é€£æŠ•ã‚¹ãƒ¬ãƒƒãƒ‰ã€‚1æŠ•ç¨¿ç›®ã¯ãƒ•ãƒƒã‚¯é‡è¦–ã€‚æœ€è¿‘ã®æ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’çµ¡ã‚ã‚‹ã€‚
                `;
                
                if (isPaid) {
                    threadsPrompt += `\nã€æœ‰æ–™è¨˜äº‹è¨´æ±‚ã€‘ã€Œç„¡æ–™éƒ¨åˆ†ã ã‘ã§ã‚‚å‹‰å¼·ã«ãªã‚‹ã€ã€Œæœ‰æ–™éƒ¨åˆ†ã¯ã•ã‚‰ã«æ¿ƒã„ã€ã¨ã„ã†ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã§ã€è³¼å…¥ã¸ã®æœŸå¾…æ„Ÿã‚’é«˜ã‚ã¦ãã ã•ã„ã€‚`;
                }

                const threadsText = await callGemini(threadsPrompt);
                renderThreads(threadsText);

                setStatus(false);

            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
                setStatus(false);
            }
        }

        function renderHashtags(text) {
            const container = document.getElementById('hashtagContent');
            container.innerHTML = '';
            const tags = text.match(/#\S+/g) || [];
            if (tags.length === 0) { container.innerText = text; return; }
            tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'hashtag-chip';
                span.innerText = tag;
                container.appendChild(span);
            });
        }

        function renderThreads(text) {
            const container = document.getElementById('threadsContent');
            container.innerHTML = '';
            const posts = text.split('---').map(p => p.trim()).filter(p => p.length > 0);
            posts.forEach((post, index) => {
                const div = document.createElement('div');
                div.className = "thread-item relative pl-8 pb-6";
                div.innerHTML = `
                    <div class="thread-line"></div>
                    <div class="absolute left-0 top-0 w-6 h-6 rounded-full bg-white text-black flex items-center justify-center font-bold text-xs z-10">${index + 1}</div>
                    <div class="text-sm text-gray-300 whitespace-pre-wrap">${post}</div>
                `;
                container.appendChild(div);
            });
        }

        function copyArticle() {
            // Copy Raw Markdown (restore paywall tag for Note editor)
            // Note: Since we only display HTML, we should ideally store raw MD. 
            // For simplicity in this demo, we copy displayed text, but for real use, Note needs Markdown or Copy/Paste.
            // Let's alert user to copy from screen for now or implement raw storage.
            const content = document.getElementById('articleContent').innerText;
            navigator.clipboard.writeText(content).then(() => alert("è¨˜äº‹æœ¬æ–‡ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\nâ€»Noteã«è²¼ã‚Šä»˜ã‘ã‚‹éš›ã¯ã€è¦‹å‡ºã—ç­‰ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚"));
        }

        function copyHashtags() {
            const container = document.getElementById('hashtagContent');
            const tags = Array.from(container.querySelectorAll('.hashtag-chip')).map(el => el.innerText).join(' ');
            navigator.clipboard.writeText(tags).then(() => alert("ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
        }

        function copyThreads() {
            const container = document.getElementById('threadsContent');
            const text = Array.from(container.querySelectorAll('.thread-item .text-sm')).map(el => el.innerText).join('\n\n---\n\n');
            navigator.clipboard.writeText(text).then(() => alert("ThreadsæŠ•ç¨¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
        }
        
        function backToTopics() {
            document.getElementById('articleSection').classList.add('hidden');
            document.getElementById('topicsSection').classList.remove('hidden');
            setStatus(false);
        }
        
        function resetAll() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('articleSection').classList.add('hidden');
            document.getElementById('keyword').value = '';
        }
    </script>
</body>
</html>
