<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Trend Factory (Safe Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #0F172A; color: #E2E8F0; }
        .prose h1, .prose h2, .prose h3 { color: #E2E8F0; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
        .prose h1 { font-size: 1.8em; border-bottom: 2px solid #334155; }
        .prose h2 { font-size: 1.5em; border-left: 5px solid #3B82F6; padding-left: 0.5em; }
        .prose p, .prose ul, .prose ol { color: #CBD5E1; margin-bottom: 1em; line-height: 1.8; }
        .prose strong { color: #38BDF8; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .topic-card:hover { transform: translateY(-2px); border-color: #3B82F6; background: rgba(59, 130, 246, 0.1); cursor: pointer; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #3B82F6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="border-b border-gray-700 sticky top-0 z-50 bg-[#0F172A]/90 backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                <span class="text-2xl">ğŸ­</span> Gemini Trend Factory
            </h1>
            <div class="flex items-center gap-4">
                <button onclick="clearApiKey()" class="text-xs text-gray-400 hover:text-red-400 underline">APIã‚­ãƒ¼ã‚’å‰Šé™¤</button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <!-- API Key Modal (Shown if key is missing) -->
        <div id="apiKeyModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
            <div class="bg-gray-800 p-8 rounded-xl max-w-md w-full border border-gray-600 shadow-2xl">
                <h2 class="text-xl font-bold text-white mb-4">åˆæœŸè¨­å®š</h2>
                <p class="text-gray-400 text-sm mb-4">Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>ã‚­ãƒ¼ã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
                <input type="password" id="inputApiKey" placeholder="sk-..." class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white mb-4 focus:border-blue-500 outline-none">
                <button onclick="saveApiKey()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition">ä¿å­˜ã—ã¦é–‹å§‹</button>
                <p class="text-xs text-gray-500 mt-4 text-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-blue-400">APIã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ (Google AI Studio)</a>
                </p>
            </div>
        </div>

        <!-- Step 1: Input -->
        <section id="inputSection" class="glass-panel p-8 rounded-xl shadow-lg text-center max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold text-white mb-2">ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ & ãƒã‚¿å‡ºã—</h2>
            <p class="text-gray-400 mb-6 text-sm">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIãŒãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æã—ã€è¨˜äº‹æ¡ˆã‚’20å€‹ææ¡ˆã—ã¾ã™ã€‚</p>
            
            <div class="relative max-w-lg mx-auto">
                <input type="text" id="keyword" placeholder="ä¾‹ï¼šAIå‰¯æ¥­ã€ãƒŸãƒ‹ãƒãƒªã‚¹ãƒˆã€æ¨ã—æ´»..." 
                    class="w-full bg-gray-800 border border-gray-600 rounded-full px-6 py-4 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-lg shadow-inner"
                    onkeydown="if(event.key === 'Enter') analyzeTrends()">
                <button onclick="analyzeTrends()" id="analyzeBtn" class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 rounded-full transition-all shadow-md flex items-center gap-2">
                    <span id="analyzeIcon">ğŸ”</span>
                </button>
            </div>
        </section>

        <!-- Status Bar -->
        <div id="statusSection" class="hidden max-w-3xl mx-auto">
            <div class="bg-gray-800 rounded-lg p-4 flex items-center gap-4 border border-gray-700 shadow-lg">
                <div class="loader"></div>
                <div class="flex-grow">
                    <p id="statusText" class="text-sm font-bold text-blue-400 typing">AI AGENT IS WORKING...</p>
                    <p id="statusSub" class="text-xs text-gray-500">GeminiãŒå¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æä¸­...</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Topic Selection -->
        <section id="topicsSection" class="hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">STEP 1</span>
                    è¨˜äº‹ãƒ†ãƒ¼ãƒæ¡ˆ (20é¸)
                </h3>
                <button onclick="resetAll()" class="text-sm text-gray-400 hover:text-white">ã‚„ã‚Šç›´ã™</button>
            </div>
            
            <div id="topicsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Topics will be injected here -->
            </div>
        </section>

        <!-- Step 3 & 4: Article Generation -->
        <section id="articleSection" class="hidden fade-in grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Outline -->
            <div class="space-y-4">
                <div class="bg-gray-800 px-4 py-2 rounded-t-lg border-b border-gray-700 flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-300">ğŸ“Š æ§‹æˆæ¡ˆ (Outline)</span>
                    <span class="text-xs bg-gray-700 text-gray-400 px-2 py-1 rounded">SEO Optimized</span>
                </div>
                <div class="glass-panel p-6 rounded-b-lg min-h-[500px] max-h-[800px] overflow-y-auto custom-scrollbar">
                    <div id="outlineContent" class="prose prose-invert max-w-none text-sm"></div>
                </div>
            </div>

            <!-- Full Body -->
            <div class="space-y-4">
                <div class="bg-blue-900/30 px-4 py-2 rounded-t-lg border-b border-blue-800/50 flex justify-between items-center">
                    <span class="text-sm font-bold text-blue-300">ğŸ“ è¨˜äº‹æœ¬æ–‡ (Draft)</span>
                    <button onclick="copyArticle()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition">ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div class="glass-panel p-6 rounded-b-lg min-h-[500px] max-h-[800px] overflow-y-auto custom-scrollbar">
                    <div id="articleContent" class="prose prose-invert max-w-none"></div>
                </div>
            </div>

        </section>

    </main>

    <script>
        // --- API Key Management ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedKey = localStorage.getItem('gemini_api_key');
            if (!storedKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
            }
        });

        function saveApiKey() {
            const key = document.getElementById('inputApiKey').value.trim();
            if (!key) return alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            localStorage.setItem('gemini_api_key', key);
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        function getApiKey() {
            return localStorage.getItem('gemini_api_key');
        }

        function clearApiKey() {
            if(confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('gemini_api_key');
                location.reload();
            }
        }

        // --- Core Functions ---

        async function callGemini(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
                throw new Error("API Key missing");
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "API Error");
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function setStatus(loading, mainText, subText) {
            const section = document.getElementById('statusSection');
            if (loading) {
                section.classList.remove('hidden');
                document.getElementById('statusText').innerText = mainText;
                document.getElementById('statusSub').innerText = subText || "";
            } else {
                section.classList.add('hidden');
            }
        }

        function resetAll() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('articleSection').classList.add('hidden');
            document.getElementById('keyword').value = '';
        }

        // --- Step 1: Trend Analysis & Topics ---

        async function analyzeTrends() {
            const keyword = document.getElementById('keyword').value;
            if (!keyword) return alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            document.getElementById('inputSection').classList.add('hidden');
            setStatus(true, "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­...", `ã€Œ${keyword}ã€å‘¨è¾ºã®å¸‚å ´ãƒ‹ãƒ¼ã‚ºã‚’ãƒªã‚µãƒ¼ãƒã—ã¦ã„ã¾ã™`);

            const prompt = `
            ã‚ãªãŸã¯ãƒ—ãƒ­ã®Webãƒãƒ¼ã‚±ã‚¿ãƒ¼å…¼ç·¨é›†é•·ã§ã™ã€‚
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€ç¾åœ¨ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„èª­è€…ã®é–¢å¿ƒäº‹ï¼ˆã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼‰ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
            ãã®ä¸Šã§ã€Noteã§å¤šãã®ã‚¹ã‚­ã‚’é›†ã‚ãã†ãªã€Œè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã®æ¡ˆã€ã‚’20å€‹ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚

            ã€æ¡ä»¶ã€‘
            - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: åˆå¿ƒè€…ã€œä¸­ç´šè€…
            - ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³: ã€Œãƒã‚¦ãƒ„ãƒ¼ã€ã€Œãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆã€ã€Œãƒ„ãƒ¼ãƒ«ç´¹ä»‹ã€ã€Œä½“é¨“è«‡ã€ã€Œé€†å¼µã‚Šã€ãªã©ç¶²ç¾…çš„ã«
            - å‡ºåŠ›å½¢å¼: JSONé…åˆ—ã®ã¿ï¼ˆä¾‹: ["ã‚¿ã‚¤ãƒˆãƒ«1", "ã‚¿ã‚¤ãƒˆãƒ«2", ...]ï¼‰
            - ä½™è¨ˆãªèª¬æ˜ã¯ä¸€åˆ‡ä¸è¦
            `;

            try {
                let text = await callGemini(prompt);
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const topics = JSON.parse(text);

                renderTopics(topics);
                setStatus(false);
                document.getElementById('topicsSection').classList.remove('hidden');

            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
                resetAll();
            }
        }

        function renderTopics(topics) {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = "";
            
            topics.forEach((title, index) => {
                const div = document.createElement('div');
                div.className = "topic-card glass-panel p-4 rounded-lg border border-gray-700 hover:border-blue-500 relative group";
                div.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2 font-mono">IDEA #${String(index + 1).padStart(2, '0')}</div>
                    <div class="font-bold text-gray-200 group-hover:text-white">${title}</div>
                    <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity text-blue-400 text-xs font-bold">åŸ·ç­†ã™ã‚‹ â†’</div>
                `;
                div.onclick = () => startWriting(title);
                grid.appendChild(div);
            });
        }

        // --- Step 2: Writing Process ---

        async function startWriting(title) {
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('articleSection').classList.remove('hidden');
            
            document.getElementById('outlineContent').innerHTML = '<div class="text-gray-500 text-center mt-20">æ§‹æˆæ¡ˆã‚’ä½œæˆä¸­...</div>';
            document.getElementById('articleContent').innerHTML = '<div class="text-gray-500 text-center mt-20">å¾…æ©Ÿä¸­...</div>';

            try {
                // 1. Outline
                setStatus(true, "SEOæ§‹æˆæ¡ˆã‚’ä½œæˆä¸­...", `ã‚¿ã‚¤ãƒˆãƒ«: ${title}`);
                const outlinePrompt = `
                ã‚¿ã‚¤ãƒˆãƒ«: ${title}
                
                ä¸Šè¨˜ã‚¿ã‚¤ãƒˆãƒ«ã®Noteè¨˜äº‹ã‚’æ›¸ããŸã‚ã®ã€ŒSEOã«å¼·ã„æ§‹æˆæ¡ˆã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                Markdownå½¢å¼ã§ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ï¼ˆãƒšãƒ«ã‚½ãƒŠï¼‰ã€æ¤œç´¢æ„å›³ã€H2è¦‹å‡ºã—ã€H3è¦‹å‡ºã—ã€å„ç« ã®è¦ç‚¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
                `;
                const outlineMd = await callGemini(outlinePrompt);
                document.getElementById('outlineContent').innerHTML = marked.parse(outlineMd);

                // 2. Full Article
                setStatus(true, "è¨˜äº‹æœ¬æ–‡ã‚’åŸ·ç­†ä¸­...", "GeminiãŒãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼ˆ3000æ–‡å­—ç›®æ¨™ï¼‰");
                const bodyPrompt = `
                ä»¥ä¸‹ã®æ§‹æˆæ¡ˆã‚’å…ƒã«ã€Noteã®è¨˜äº‹æœ¬æ–‡ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚
                
                ã€æ§‹æˆæ¡ˆã€‘
                ${outlineMd}

                ã€åŸ·ç­†ãƒ«ãƒ¼ãƒ«ã€‘
                - åª’ä½“: Note
                - ãƒˆãƒ¼ãƒ³: è¦ªã—ã¿ã‚„ã™ãã€å°‚é–€æ€§ãŒã‚ã‚‹ï¼ˆ"ã§ã™ãƒ»ã¾ã™"èª¿ï¼‰
                - æ–‡å­—æ•°: å……å®Ÿã—ãŸå†…å®¹ã«ã™ã‚‹ï¼ˆ3000æ–‡å­—ç¨‹åº¦ï¼‰
                - èª­è€…ã¸ã®å…±æ„Ÿã¨ã€å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’å¿…ãšå«ã‚ã‚‹
                - Markdownå½¢å¼ã§å‡ºåŠ›
                `;
                const articleMd = await callGemini(bodyPrompt);
                document.getElementById('articleContent').innerHTML = marked.parse(articleMd);

                setStatus(false);

            } catch (e) {
                alert("åŸ·ç­†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
            }
        }

        function copyArticle() {
            const content = document.getElementById('articleContent').innerText;
            navigator.clipboard.writeText(content).then(() => alert("è¨˜äº‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
        }
    </script>
</body>
</html>
